<!DOCTYPE html>
<html lang="en">
  <head><meta charset="UTF-8"/>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="concurrentå·¥å…·ç±»"/><meta name="keywords" content="java, juc, concurrent, countdownlatch, cyclicbarrier, semaphore, Onns Blog" /><link rel="alternate" href="/blog/default" title="Onns Blog"><link rel="shortcut icon" type="image/x-icon" href="/blog/favicon.ico?v=2.11.0" />
<link rel="canonical" href="https://onns.xyz/2020/09/12/concurrent-utility-class/"/>

<link rel="stylesheet" type="text/css" href="/blog/lib/fancybox/jquery.fancybox.css" /><script type="text/javascript">
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]  
      },
      svg: {
        fontCache: 'global'
      }
    };
  </script>
  <script type="text/javascript" async src="//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<link rel="stylesheet" type="text/css" href="/blog/css/style.css?v=2.11.0" />

<script id="baidu_analytics">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?094f3776af9873aa4bf55d2700e2b1cc";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-127068305-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-127068305-1');
</script><script src="//onns.xyz/js/av-min.js"></script>
  <script id="leancloud">
    AV.init({
      appId: "jIRe5LRqbWDB2dxmu7FH8c1S-gzGzoHsz",
      appKey: "pM10kNYtPMwvqYUCWfbUGBPJ",
      serverURLs: "https://jire5lrq.lc-cn-n1-shared.com"
    });
  </script><script>
  window.config = {"leancloud":{"app_id":"jIRe5LRqbWDB2dxmu7FH8c1S-gzGzoHsz","app_key":"pM10kNYtPMwvqYUCWfbUGBPJ","server_urls":"https://jire5lrq.lc-cn-n1-shared.com"},"toc":true,"fancybox":true,"pjax":true,"latex":true};
</script>

<script id="search">
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        success: function( xmlResponse ) {
            // get the contents from search data
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();

            var $input = document.getElementById(search_id);
			if (!$input) return;
            var $resultContent = document.getElementById(content_id);
            
            $input.addEventListener('input', function () {
                var str = '<section class=\"posts\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length <= 0) {
                    return;
                }
                // perform local searching
                datas.forEach(function (data) {
                    var isMatch = true;
                    var content_index = [];
                    if (!data.title || data.title.trim() === '') {
                        data.title = "Untitled";
                    }
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty contents
                    if (data_content !== '') {
                        keywords.forEach(function (keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);

                            if (index_title < 0 && index_content < 0) {
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                                // content_index.push({index_content:index_content, keyword_len:keyword_len});
                            }
                        });
                    } else {
                        isMatch = false;
                    }
                    // show search results
                    if (isMatch) {
                        str += `
<article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="`+ data_url +`">`+ data_title +`</a>
        </h1>
    </header>
    <div class="post-content">
        `;
                        var content = data.content.trim().replace(/<[^>]+>/g, "");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;

                            if (start < 0) {
                                start = 0;
                            }

                            if (start == 0) {
                                end = 100;
                            }

                            if (end > content.length) {
                                end = content.length;
                            }

                            var match_content = content.substring(start, end);

                            // highlight all keywords
                            keywords.forEach(function (keyword) {
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<code>" + keyword + "</code>");
                            });

                            str += "<p>" + match_content + "...</p>"
                        }
                        str += "</article>";
                    }
                });
                str += "</section>";
                $resultContent.innerHTML = str;
            });
        }
    });
}    
var search_path = "search.xml";
if (search_path.length == 0) {
search_path = "search.xml";
}
var path = "/blog/" + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script>
    <title>concurrentå·¥å…·ç±» - Onns Blog</title>
  <meta name="generator" content="Hexo 4.2.1"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="mobile-header-logo">
    <a href="/blog/." class="logo">Onns Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/blog/home">
        <li class="mobile-menu-item">Home
          </li>
      </a><a href="/blog/archives">
        <li class="mobile-menu-item">Archives
          </li>
      </a><a href="/blog/tags">
        <li class="mobile-menu-item">Tags
          </li>
      </a><a href="/blog/categories">
        <li class="mobile-menu-item">Categories
          </li>
      </a><a href="/blog/about">
        <li class="mobile-menu-item">About
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/blog/." class="logo">Onns Blog</a>
</div>

<nav class="site-navbar"><div class="search-button">
        <a href="#" class="search-toggle" data-selector=".site-navbar"></a>
    </div>
    <div class="search-box">
        <input type="text" id="local-search-input" class="text search-input" placeholder="Type here to search..." />
    </div><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/blog/home">
            Home
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/blog/archives">
            Archives
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/blog/tags">
            Tags
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/blog/categories">
            Categories
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/blog/about">
            About
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            <div id="local-search-result"></div><article class="post">
    <header class="post-header">
      <h1 class="post-title">concurrentå·¥å…·ç±»
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2020-09-12 18:50:42
        </span><span class="post-category">
            <a href="/blog/categories/learn/">learn</a>
            </span>
        <span class="post-visits"
             data-url="/blog/2020/09/12/concurrent-utility-class/"
             data-title="concurrentå·¥å…·ç±»">
          Visits 0
        </span>
        </div>
    </header>

    <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#countdownlatch"><span class="toc-text">CountDownLatch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cyclicbarrier"><span class="toc-text">CyclicBarrier</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ç›¸å…³é“¾æ¥"><span class="toc-text">ç›¸å…³é“¾æ¥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#semaphore"><span class="toc-text">Semaphore</span></a></li></ol>
    </div>
  </div><div class="post-content"><p>concurrent å·¥å…·ç±»</p>
<a id="more"></a>
<h2 id="countdownlatch"><a class="header-anchor" href="#countdownlatch">#</a>CountDownLatch</h2>
<p><strong>é˜»å¡ç›´åˆ°æ•°å®Œä¸ºæ­¢</strong></p>
<p>æ¯”å¦‚è¯´ä¸‹ç­é”é—¨ï¼Œå¿…é¡»è¦ç­‰å±‹å­é‡Œæ‰€æœ‰äººéƒ½èµ°äº†ä¹‹åï¼Œæ‰èƒ½é”é—¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> xyz.onns.juc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchTest</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">		CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">9</span>);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">9</span>; i++) &#123;</span><br><span class="line">			<span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">				System.out.println(Thread.currentThread().getName() + <span class="string">" count down!"</span>);</span><br><span class="line">				countDownLatch.countDown();</span><br><span class="line">			&#125;, String.valueOf(i + <span class="number">1</span>)).start();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		countDownLatch.await();</span><br><span class="line"></span><br><span class="line">		System.out.println(<span class="string">"Done"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ /Library/Java/JavaVirtualMachines/jdk-13.0.2.jdk/Contents/Home/bin/java -javaagent:/Applications/IntelliJ IDEA.app/Contents/lib/idea_rt.jar=57648:/Applications/IntelliJ IDEA.app/Contents/bin -Dfile.encoding=UTF-8 -classpath /Users/onns/Documents/code/java/jvm/out/production/jvm xyz.onns.juc.CountDownLatchTest</span><br><span class="line">1 count down!</span><br><span class="line">2 count down!</span><br><span class="line">3 count down!</span><br><span class="line">4 count down!</span><br><span class="line">5 count down!</span><br><span class="line">6 count down!</span><br><span class="line">7 count down!</span><br><span class="line">8 count down!</span><br><span class="line">9 count down!</span><br><span class="line">Done</span><br><span class="line"></span><br><span class="line">Process finished with <span class="built_in">exit</span> code 0</span><br></pre></td></tr></table></figure>
<p>å‡å¦‚ä¸Šé¢çš„<code>i</code>å˜æˆ<code>10</code>ï¼Œç¬¬åä¸ªäººæ˜¯å¦ä¼šâ€œè¢«é”åœ¨é‡Œé¢â€æ˜¯ä¸å›ºå®šçš„ã€‚</p>
<h2 id="cyclicbarrier"><a class="header-anchor" href="#cyclicbarrier">#</a>CyclicBarrier</h2>
<p><strong>ç­‰å¾…å‰ç½®æ¡ä»¶å…¨éƒ¨æ»¡è¶³ä¹‹åï¼Œæ‰ä¼šæ‰§è¡Œåé¢çš„æ“ä½œ</strong></p>
<p>å¿…é¡»è¦é›†é½<code>ä¸ƒé¢—é¾™ç </code>ï¼Œæ‰èƒ½å¬å”¤ç¥é¾™ ğŸ²ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> xyz.onns.juc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.BrokenBarrierException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CyclicBarrier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrierTest</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		CyclicBarrier cyclicBarrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">7</span>, () -&gt; &#123;</span><br><span class="line">			System.out.println(<span class="string">"å¬å”¤ç¥é¾™ï¼"</span>);</span><br><span class="line">		&#125;);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) &#123;</span><br><span class="line">			<span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">				System.out.println(Thread.currentThread().getName() + <span class="string">"æ”¶é›†ç¬¬"</span> + (i + <span class="number">1</span>) + <span class="string">"ä¸ªé¾™ç "</span>);</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					cyclicBarrier.await();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (BrokenBarrierException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;, <span class="string">"çº¿ç¨‹"</span> + String.valueOf(i + <span class="number">1</span>)).start();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å†™ï¼Œç¬¬åä¸‰è¡Œä¼šæŠ¥é”™ï¼š</p>
<blockquote>
<p>Variable used in lambda expression should be final or effectively final</p>
</blockquote>
<p>æŸ¥äº†ä¸€ä¸‹ï¼Œé¦–å…ˆï¼Œè¿™æ ·åšçš„åŸå› æ˜¯ï¼Œå› ä¸º Java æ˜¯è¿™æ ·è§„å®šçš„ï¼š<a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-15.html#jls-15.27.2" target="_blank" rel="noopener">Lambda Expressions</a></p>
<blockquote>
<p>Any local variable, formal parameter, or exception parameter used but not declared in a lambda expression must either be declared final or be effectively final (Â§4.12.4), or a compile-time error occurs where the use is attempted.</p>
</blockquote>
<p>è‡³äºä¸ºä»€ä¹ˆä¼šè¿™æ ·è§„å®šï¼Œå‚ç…§è¿™é‡Œï¼š<a href="https://stackoverflow.com/a/4732617/13182099" target="_blank" rel="noopener">Why are only final variables accessible in anonymous class?</a></p>
<blockquote>
<p>When you create an instance of an anonymous inner class, any variables which are used within that class have their values copied in via the autogenerated constructor. This avoids the compiler having to autogenerate various extra types to hold the logical state of the â€œlocal variablesâ€, as for example the C# compiler doesâ€¦ (When C# captures a variable in an anonymous function, it really captures the variable - the closure can update the variable in a way which is seen by the main body of the method, and vice versa.)<br>
As the value has been copied into the instance of the anonymous inner class, it would look odd if the variable could be modified by the rest of the method - you could have code which appeared to be working with an out-of-date variable (because thatâ€™s effectively what would be happeningâ€¦ youâ€™d be working with a copy taken at a different time). Likewise if you could make changes within the anonymous inner class, developers might expect those changes to be visible within the body of the enclosing method.<br>
Making the variable final removes all these possibilities - as the value canâ€™t be changed at all, you donâ€™t need to worry about whether such changes will be visible. The only ways to allow the method and the anonymous inner class see each otherâ€™s changes is to use a mutable type of some description. This could be the enclosing class itself, an array, a mutable wrapper typeâ€¦ anything like that. Basically itâ€™s a bit like communicating between one method and another: changes made to the parameters of one method arenâ€™t seen by its caller, but changes made to the objects referred to by the parameters are seen.</p>
</blockquote>
<p>ç®€å•æ¥è¯´ï¼Œå®ç°å¯ä¿®æ”¹çš„å˜é‡åŠŸèƒ½æ‰€å¸¦æ¥ä¾¿åˆ©ï¼Œæ²¡æœ‰éšä¹‹è€Œæ¥çš„é—®é¢˜å¤šã€‚</p>
<p>è§£å†³åŠæ³•å°±æ˜¯ï¼ŒåŠ ä¸€ä¸ª<code>final</code>å˜é‡ï¼Œå…¶å®ä»<code>Java 1.8</code>ä¹‹åï¼Œä½ ä¸åŠ <code>final</code>å…³é”®å­—ï¼Œåªè¦è¿™ä¸ªå€¼æ²¡è¢«ä¿®æ”¹ï¼Œä¹Ÿä¼šé»˜è®¤è§†ä½œ<code>final</code>çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> xyz.onns.juc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.BrokenBarrierException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CyclicBarrier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrierTest</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		CyclicBarrier cyclicBarrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">7</span>, () -&gt; &#123;</span><br><span class="line">			System.out.println(<span class="string">"å¬å”¤ç¥é¾™ï¼"</span>);</span><br><span class="line">		&#125;);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) &#123;</span><br><span class="line">			<span class="keyword">int</span> finalI = i;</span><br><span class="line">			<span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">				System.out.println(Thread.currentThread().getName() + <span class="string">"æ”¶é›†ç¬¬"</span> + (finalI + <span class="number">1</span>) + <span class="string">"ä¸ªé¾™ç "</span>);</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					cyclicBarrier.await();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (BrokenBarrierException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;, <span class="string">"çº¿ç¨‹"</span> + String.valueOf(i + <span class="number">1</span>)).start();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ /Library/Java/JavaVirtualMachines/jdk-13.0.2.jdk/Contents/Home/bin/java -javaagent:/Applications/IntelliJ IDEA.app/Contents/lib/idea_rt.jar=57758:/Applications/IntelliJ IDEA.app/Contents/bin -Dfile.encoding=UTF-8 -classpath /Users/onns/Documents/code/java/jvm/out/production/jvm xyz.onns.juc.CyclicBarrierTest</span><br><span class="line">çº¿ç¨‹4æ”¶é›†ç¬¬4ä¸ªé¾™ç </span><br><span class="line">çº¿ç¨‹5æ”¶é›†ç¬¬5ä¸ªé¾™ç </span><br><span class="line">çº¿ç¨‹7æ”¶é›†ç¬¬7ä¸ªé¾™ç </span><br><span class="line">çº¿ç¨‹6æ”¶é›†ç¬¬6ä¸ªé¾™ç </span><br><span class="line">çº¿ç¨‹2æ”¶é›†ç¬¬2ä¸ªé¾™ç </span><br><span class="line">çº¿ç¨‹3æ”¶é›†ç¬¬3ä¸ªé¾™ç </span><br><span class="line">çº¿ç¨‹1æ”¶é›†ç¬¬1ä¸ªé¾™ç </span><br><span class="line">å¬å”¤ç¥é¾™ï¼</span><br><span class="line"></span><br><span class="line">Process finished with <span class="built_in">exit</span> code 0</span><br></pre></td></tr></table></figure>
<h2 id="ç›¸å…³é“¾æ¥"><a class="header-anchor" href="#ç›¸å…³é“¾æ¥">#</a>ç›¸å…³é“¾æ¥</h2>
<ul>
<li><a href="https://blog.csdn.net/qq_36221788/article/details/100584500" target="_blank" rel="noopener">Variable used in lambda expression should be final or effectively final</a></li>
<li><a href="https://www.jianshu.com/p/e7a51617c568" target="_blank" rel="noopener">ç¼–è¯‘å™¨è¯´ Lambda è¡¨è¾¾å¼ä¸­çš„å˜é‡å¿…é¡»æ˜¯ final çš„ï¼Œæˆ‘åä¸ä¿¡</a></li>
<li><a href="https://stackoverflow.com/questions/50456920/why-does-variables-in-lambdas-have-to-be-final-or-effectively-final/50457016" target="_blank" rel="noopener">Why does variables in lambdas have to be final or effectively final? [duplicate]</a></li>
<li><a href="https://stackoverflow.com/questions/25055392/lambdas-local-variables-need-final-instance-variables-dont" target="_blank" rel="noopener">Lambdas: local variables need final, instance variables donâ€™t</a></li>
<li><a href="https://stackoverflow.com/a/4732617/13182099" target="_blank" rel="noopener">Why are only final variables accessible in anonymous class?</a></li>
</ul>
<h2 id="semaphore"><a class="header-anchor" href="#semaphore">#</a>Semaphore</h2>
<p><strong>ä¿¡å·é‡</strong></p>
<p>æŠ¢è½¦ä½ï¼Œæœ‰ç©ºè½¦ä½æ‰èƒ½åœè½¦</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> xyz.onns.juc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreTest</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">3</span>);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">9</span>; i++) &#123;</span><br><span class="line">			<span class="keyword">int</span> finalI = i % <span class="number">3</span> + <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					semaphore.acquire(finalI);</span><br><span class="line">					System.out.println(Thread.currentThread().getName() + <span class="string">"è·å¾—äº†"</span> + finalI + <span class="string">"ä¸ªè½¦ä½"</span>);</span><br><span class="line">					TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">					<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; finalI; j++) &#123;</span><br><span class="line">						semaphore.release();</span><br><span class="line">						System.out.println(Thread.currentThread().getName() + <span class="string">"é‡Šæ”¾äº†ç¬¬"</span> + (j + <span class="number">1</span>) + <span class="string">"ä¸ªè½¦ä½"</span>);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;, String.valueOf(i + <span class="number">1</span>)).start();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ /Library/Java/JavaVirtualMachines/jdk-13.0.2.jdk/Contents/Home/bin/java -javaagent:/Applications/IntelliJ IDEA.app/Contents/lib/idea_rt.jar=58074:/Applications/IntelliJ IDEA.app/Contents/bin -Dfile.encoding=UTF-8 -classpath /Users/onns/Documents/code/java/jvm/out/production/jvm xyz.onns.juc.SemaphoreTest</span><br><span class="line">1è·å¾—äº†1ä¸ªè½¦ä½</span><br><span class="line">2è·å¾—äº†2ä¸ªè½¦ä½</span><br><span class="line">1é‡Šæ”¾äº†ç¬¬1ä¸ªè½¦ä½</span><br><span class="line">2é‡Šæ”¾äº†ç¬¬1ä¸ªè½¦ä½</span><br><span class="line">2é‡Šæ”¾äº†ç¬¬2ä¸ªè½¦ä½</span><br><span class="line">3è·å¾—äº†3ä¸ªè½¦ä½</span><br><span class="line">4è·å¾—äº†1ä¸ªè½¦ä½</span><br><span class="line">3é‡Šæ”¾äº†ç¬¬1ä¸ªè½¦ä½</span><br><span class="line">3é‡Šæ”¾äº†ç¬¬2ä¸ªè½¦ä½</span><br><span class="line">3é‡Šæ”¾äº†ç¬¬3ä¸ªè½¦ä½</span><br><span class="line">5è·å¾—äº†2ä¸ªè½¦ä½</span><br><span class="line">5é‡Šæ”¾äº†ç¬¬1ä¸ªè½¦ä½</span><br><span class="line">4é‡Šæ”¾äº†ç¬¬1ä¸ªè½¦ä½</span><br><span class="line">6è·å¾—äº†3ä¸ªè½¦ä½</span><br><span class="line">5é‡Šæ”¾äº†ç¬¬2ä¸ªè½¦ä½</span><br><span class="line">6é‡Šæ”¾äº†ç¬¬1ä¸ªè½¦ä½</span><br><span class="line">6é‡Šæ”¾äº†ç¬¬2ä¸ªè½¦ä½</span><br><span class="line">7è·å¾—äº†1ä¸ªè½¦ä½</span><br><span class="line">6é‡Šæ”¾äº†ç¬¬3ä¸ªè½¦ä½</span><br><span class="line">8è·å¾—äº†2ä¸ªè½¦ä½</span><br><span class="line">8é‡Šæ”¾äº†ç¬¬1ä¸ªè½¦ä½</span><br><span class="line">8é‡Šæ”¾äº†ç¬¬2ä¸ªè½¦ä½</span><br><span class="line">7é‡Šæ”¾äº†ç¬¬1ä¸ªè½¦ä½</span><br><span class="line">9è·å¾—äº†3ä¸ªè½¦ä½</span><br><span class="line">9é‡Šæ”¾äº†ç¬¬1ä¸ªè½¦ä½</span><br><span class="line">9é‡Šæ”¾äº†ç¬¬2ä¸ªè½¦ä½</span><br><span class="line">9é‡Šæ”¾äº†ç¬¬3ä¸ªè½¦ä½</span><br><span class="line"></span><br><span class="line">Process finished with <span class="built_in">exit</span> code 0</span><br></pre></td></tr></table></figure>
<p>åœ¨æ•™ç¨‹çš„åŸºç¡€ä¸Šæ”¹å˜äº†äº›ï¼Œå‘ç°å‡º bug äº†= =</p>
<center>
<p><img src="//onns.xyz/blog/image/20200912-14.jpg" alt="å‡ºç°é—®é¢˜"></p>
</center>
<p>æ‰¾äº†åŠä¸ªå¤šå°æ—¶ï¼Œè§£å†³äº†ï¼</p>
<p>é‡Šæ”¾è½¦ä½è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œä¸åº”è¯¥åœ¨åœ¨é‡Šæ”¾ä¹‹åï¼Œè¿™æ ·å¯èƒ½ä¼šï¼Œé‡Šæ”¾äº†ä½†æ˜¯æ¥ä¸åŠæ‰“å°ï¼Œé‚£è¾¹çº¿ç¨‹å°±å·²ç»æ‹¿åˆ°è½¦ä½äº†ã€‚</p>
<p><code>é‡Šæ”¾è½¦ä½</code> -&gt; <code>è·å¾—è½¦ä½</code> -&gt; <code>æ‰“å°è¾“å‡º</code></p>
<p><code>é‡Šæ”¾è½¦ä½</code> -&gt; <code>æ‰“å°è¾“å‡º</code> -&gt; <code>è·å¾—è½¦ä½</code></p>
<p>ç¬¬ä¸€æ­¥ä¹‹åï¼Œå¦å¤–çš„ä¸¤æ­¥æ˜¯æ²¡æœ‰åŠæ³•ä¿è¯é¡ºåºçš„ï¼æ‰€ä»¥æ”¹ä¸ºï¼š</p>
<p><code>æ‰“å°è¾“å‡º</code> -&gt; <code>é‡Šæ”¾è½¦ä½</code> -&gt; <code>è·å¾—è½¦ä½</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> xyz.onns.juc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreTest</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">3</span>);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">9</span>; i++) &#123;</span><br><span class="line">			<span class="keyword">int</span> finalI = i % <span class="number">3</span> + <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					semaphore.acquire(finalI);</span><br><span class="line">					System.out.println(<span class="string">"çº¿ç¨‹"</span> + Thread.currentThread().getName() + <span class="string">"è·å¾—äº†"</span> + finalI + <span class="string">"ä¸ªè½¦ä½"</span>);</span><br><span class="line">					TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">					<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; finalI; j++) &#123;</span><br><span class="line">						System.out.println(<span class="string">"çº¿ç¨‹"</span> + Thread.currentThread().getName() + <span class="string">"é‡Šæ”¾ç¬¬"</span> + (j + <span class="number">1</span>) + <span class="string">"ä¸ªè½¦ä½"</span>);</span><br><span class="line">						semaphore.release();</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;, String.valueOf(i + <span class="number">1</span>)).start();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ /Library/Java/JavaVirtualMachines/jdk-13.0.2.jdk/Contents/Home/bin/java -javaagent:/Applications/IntelliJ IDEA.app/Contents/lib/idea_rt.jar=58503:/Applications/IntelliJ IDEA.app/Contents/bin -Dfile.encoding=UTF-8 -classpath /Users/onns/Documents/code/java/jvm/out/production/jvm xyz.onns.juc.SemaphoreTest</span><br><span class="line">çº¿ç¨‹1è·å¾—äº†1ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹2è·å¾—äº†2ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹1é‡Šæ”¾ç¬¬1ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹2é‡Šæ”¾ç¬¬1ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹2é‡Šæ”¾ç¬¬2ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹3è·å¾—äº†3ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹3é‡Šæ”¾ç¬¬1ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹3é‡Šæ”¾ç¬¬2ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹4è·å¾—äº†1ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹3é‡Šæ”¾ç¬¬3ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹5è·å¾—äº†2ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹4é‡Šæ”¾ç¬¬1ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹5é‡Šæ”¾ç¬¬1ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹5é‡Šæ”¾ç¬¬2ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹6è·å¾—äº†3ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹6é‡Šæ”¾ç¬¬1ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹6é‡Šæ”¾ç¬¬2ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹7è·å¾—äº†1ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹6é‡Šæ”¾ç¬¬3ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹8è·å¾—äº†2ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹8é‡Šæ”¾ç¬¬1ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹7é‡Šæ”¾ç¬¬1ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹8é‡Šæ”¾ç¬¬2ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹9è·å¾—äº†3ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹9é‡Šæ”¾ç¬¬1ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹9é‡Šæ”¾ç¬¬2ä¸ªè½¦ä½</span><br><span class="line">çº¿ç¨‹9é‡Šæ”¾ç¬¬3ä¸ªè½¦ä½</span><br><span class="line"></span><br><span class="line">Process finished with <span class="built_in">exit</span> code 0</span><br></pre></td></tr></table></figure>
<p>å®Œã€‚</p>

      </div>
      
      <footer class="post-footer">
        <div class="post-tags">
            <a href="/blog/tags/java/">java</a>
            <a href="/blog/tags/juc/">juc</a>
            <a href="/blog/tags/concurrent/">concurrent</a>
            <a href="/blog/tags/countdownlatch/">countdownlatch</a>
            <a href="/blog/tags/cyclicbarrier/">cyclicbarrier</a>
            <a href="/blog/tags/semaphore/">semaphore</a>
            </div>
        
        <nav class="post-nav"><a class="prev" href="/blog/2020/09/13/solution-of-maximum-subarray/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">Leetcodeé¢˜è§£ï¼šæœ€å¤§å­åºå’Œ</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    <a class="next" href="/blog/2020/09/12/use-vba-in-excel/">
        <span class="next-text nav-default">åœ¨Excelä¸­ä½¿ç”¨å®</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments"><div id="gitalk-container"></div>
    </div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:onns@onns.xyz" class="iconfont icon-email" title="email"></a>
        <a href="https://facebook.com/onnsxyz" target="_blank" rel="noopener" class="iconfont icon-facebook" title="facebook"></a>
        <a href="https://github.com/onns" target="_blank" rel="noopener" class="iconfont icon-github" title="github"></a>
        <a href="https://www.douban.com/people/onnsxyz/" target="_blank" rel="noopener" class="iconfont icon-douban" title="douban"></a>
        <a href="https://instagram.com/onnsxyz" target="_blank" rel="noopener" class="iconfont icon-instagram" title="instagram"></a>
        <a href="/blog/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even" target="_blank" rel="noopener">Even</a>
  </span>

  <span class="copyright-year">&copy;2015 - 2022<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Onns</span>
    <span class="licence"> <a href="http://www.beian.miit.gov.cn" target="_blank" rel="noopener">é—½ICPå¤‡15022938å·-2</a> </span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>


<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css"/>


<script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>

<script>
  var gitalk = new Gitalk({
    clientID: '7ebadcd52312c2b34f81',
    clientSecret: '052f4cb2121b344c1acd459e277d1bcdc53d1bce',
    repo: 'onns.xyz',
    owner: 'onns',
    admin: ['onns'],
    id: md5(location.pathname),
    
      language: window.navigator.language || window.navigator.userLanguage,
    
    distractionFreeMode: 'true'
  });
  gitalk.render('gitalk-container');
</script><script type="text/javascript" src="/blog/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/blog/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/blog/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/blog/js/src/even.js?v=2.11.0"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>
