<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>炉石卡组</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <style>
      body {
        padding: 20px;
        background-color: #f8f9fa;
      }
      h1 {
        margin-bottom: 20px;
      }
      .filter-group {
        margin-bottom: 15px;
      }
      .table-responsive {
        width: 100%;
        overflow-x: auto;
      }
      table {
        margin-top: 20px;
        width: 100%;
        table-layout: auto;
      }
      th,
      td {
        word-wrap: break-word;
        white-space: nowrap;
      }
      th {
        background-color: #007bff;
        color: white;
      }
      .spinner-border {
        display: none;
      }
    .code-column {
    max-width:150px;
    white-space: pre-wrap;
    }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <h1 class="text-center">炉石头部对局查看</h1>

      <div class="row">
        <div class="col-md-2 filter-group">
          <label for="auth">认证代码</label>
          <input type="text" class="form-control" id="auth" />
        </div>
        <div class="col-md-2 filter-group">
          <label for="format">模式</label>
          <select class="form-control" id="format">
            <option value="">请选择</option>
            <option value="standard">标准</option>
            <option value="wild">狂野</option>
            <option value="twist">幻变</option>
          </select>
        </div>
        <div class="col-md-4 filter-group">
          <label for="code">代码片段</label>
          <input type="text" class="form-control" id="code" />
        </div>
      </div>
      <div class="row">
        <div class="col-md-2 filter-group">
          <label for="from">起始时间</label>
          <input type="text" class="form-control" id="from" />
        </div>
        <div class="col-md-2 filter-group">
          <label for="to">结束时间</label>
          <input type="text" class="form-control" id="to" />
        </div>
      </div>
      <div class="row">
        <div class="col-md-2 filter-group">
          <label for="sort">排序</label>
          <select class="form-control" id="sort">
            <option value="rate">胜率</option>
            <option value="count">场次</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary" onclick="fetchData()">请求数据</button>
      <div
        class="spinner-border text-primary"
        role="status"
        id="loadingSpinner"
      >
        <span class="sr-only">加载中...</span>
      </div>

      <div class="table-responsive">
        <table class="table table-striped" id="data-table">
          <thead>
            <tr>
              <th>模式</th>
              <th>赢/输</th>
              <th>总场次</th>
              <th>胜率</th>
              <th>排名区间</th>
              <th>平均对局时长</th>
              <th>最后对局时间</th>
              <th>卡组</th>
              <th>代码</th>
              <th>汇总</th>
              <!-- 根据需要添加更多的列 -->
            </tr>
          </thead>
          <tbody>
            <!-- 数据行将插入到这里 -->
          </tbody>
        </table>
      </div>
    </div>

    <script>
      async function fetchData() {
        const auth = document.getElementById("auth").value;
        const code = document.getElementById("code").value;
        const from = document.getElementById("from").value;
        const to = document.getElementById("to").value;
        const format = document.getElementById("format").value;
        const sort= document.getElementById("sort").value;

        const params = new URLSearchParams({auth,code,from,to,format,sort}).toString();
            const newUrl = `${window.location.pathname}?${params}`;
            
            // 更新浏览器地址栏的URL
            window.history.pushState({}, '', newUrl);

        // 显示加载指示器
        document.getElementById("loadingSpinner").style.display =
          "inline-block";

        // 构建请求URL和参数
        const url = `https://onns.xyz/hs/code-top?limit=100&auth=${auth}&format=${format}&code=${code}&render=json&from=${from}&to=${to}&sort=${sort}`;

        try {
          const response = await fetch(url);
          const data = await response.json();

          // 隐藏加载指示器
          document.getElementById("loadingSpinner").style.display = "none";

          // 渲染数据到表格
          const tableBody = document
            .getElementById("data-table")
            .querySelector("tbody");
          tableBody.innerHTML = "";

          data.data.forEach((item) => {
            const row = document.createElement("tr");
            if (item.deck == null){
              item.deck = [];
            } 
            // 假设数据包含 'column1', 'column2', 'column3'
            row.innerHTML = `
                        <td>${item.format}</td>
                        <td>${item.win_count}/${item.lose_count}</td>
                        <td>${item.win_count + item.lose_count}</td>
                        <td>${(
                          (item.win_count * 100) /
                          (item.win_count + item.lose_count)
                        ).toFixed(2)}%</td>
                        <td>${item.min_rank} ~ ${item.max_rank}</td>
                        <td>${(
                          (item.win_duration + item.lose_duration) /
                          (item.win_count + item.lose_count) /
                          60
                        ).toFixed(2)}分</td>
                        <td>${item.ctime}</td>
                        <td>${item.deck.join("<br/>")}</td>
                        <td class="code-column"><a href="https://onns.xyz/hs/code-gen?code=${
                          item.deck_code
                        }" target="_blank">${item.deck_code}</a></td>
                        <td>总场数：${item.win_count+item.lose_count}<br/>赢${item.win_count}/输${item.lose_count}<br/>胜率：${(
                          (item.win_count * 100) /
                          (item.win_count + item.lose_count)
                        ).toFixed(2)}%<br/>排名区间：${item.min_rank} ~ ${item.max_rank}<br/>平均对局时长：${(
                          (item.win_duration + item.lose_duration) /
                          (item.win_count + item.lose_count) /
                          60
                        ).toFixed(2)}分钟<br/>最后更新时间：${item.ctime}</td>
                    `;
            tableBody.appendChild(row);
          });
        } catch (error) {
          console.error("请求数据失败:", error);
          // 隐藏加载指示器
          document.getElementById("loadingSpinner").style.display = "none";
        }
      }
      window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            for (const [key, value] of params) {
                const input = document.querySelector(`[id="${key}"]`);
                if (input) {
                    input.value = value;
                }
            }
            if (params.toString()) {
                submitData(); // 自动提交数据以加载表格
            }
        }
    </script>
  </body>
</html>

